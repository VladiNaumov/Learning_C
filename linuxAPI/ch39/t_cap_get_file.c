/* t_cap_get_file.c

   Эта программа отображает возможности, прикрепленные к файлу.

   Программа использует системный вызов cap_get_file для получения возможностей, прикрепленных к файлу по пути, указанному в аргументах командной строки.
   После этого она выводит их в текстовом формате с помощью cap_to_text.
*/

#include <sys/capability.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>
#include <stdlib.h>

#define errExit(msg)    do { perror(msg); exit(EXIT_FAILURE); \
                        } while (0)

int main(int argc, char *argv[])
{
    // Проверка аргументов командной строки
    if (argc < 2) {
        fprintf(stderr, "Usage: %s <pathname>\n", argv[0]);  // Если путь не указан, вывести инструкцию
        exit(EXIT_FAILURE);
    }

    // Получаем возможности файла, указанного в аргументе командной строки
    cap_t caps = cap_get_file(argv[1]);

    // Обрабатываем ошибку, если файл не имеет прикрепленных возможностей
    if (caps == NULL) {
        if (errno == ENODATA)  // Нет прикрепленных возможностей
            printf("No capabilities are attached to this file\n");
        else
            errExit("cap_get_file");  // В случае других ошибок вызываем errExit
    } else {
        // Преобразуем возможности в текстовый формат
        char *str = cap_to_text(caps, NULL);
        if (str == NULL)
            errExit("cap_to_text");  // В случае ошибки преобразования

        // Выводим возможности файла
        printf("Capabilities: %s\n", str);

        cap_free(str);  // Освобождаем память, занятую строкой
    }

    cap_free(caps);  // Освобождаем память, занятую структурами возможностей

    exit(EXIT_SUCCESS);  // Завершаем программу
}

/*

### Объяснение кода:
1. **Проверка аргументов**:
   - Программа проверяет, был ли передан путь к файлу в качестве аргумента командной строки. Если нет, она выводит инструкцию по использованию.

2. **cap_get_file**:
   - Функция `cap_get_file` используется для получения возможностей, прикрепленных к файлу, заданному путем. Она возвращает структуру типа `cap_t`.

3. **Обработка ошибки**:
   - Если `cap_get_file` возвращает `NULL`, это может означать, что файл не имеет прикрепленных возможностей. В таком случае проверяется переменная `errno`:
     - Если ошибка — `ENODATA`, выводится сообщение, что файл не имеет прикрепленных возможностей.
     - Если ошибка другая, программа вызывает `errExit`.

4. **cap_to_text**:
   - Если файл имеет прикрепленные возможности, они преобразуются в текстовый формат с помощью функции `cap_to_text`, и результат выводится в консоль.

5. **Очистка памяти**:
   - После использования `cap_t` и строки, полученной с помощью `cap_to_text`, программа освобождает выделенную память с помощью `cap_free`.

6. **Пример использования**:
   ```bash
   ./t_cap_get_file /path/to/file  # Где /path/to/file - это путь к файлу, чьи возможности нужно вывести
   ```

7. **Обработка ошибок**:
   - Программа завершится с сообщением об ошибке, если не удастся получить или преобразовать возможности файла.
   
*/
