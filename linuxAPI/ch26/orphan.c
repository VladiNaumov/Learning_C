/* orphan.c

   Демонстрация того, как дочерний процесс становится сиротой (и принимает
   процесс init(1) в качестве родителя), когда его родитель завершается.

   История изменений:
   2019-02-15   Изменения для учета того, что в системах с современной
                системой init (например, systemd), осиротевший дочерний
                процесс может быть принят "подпроцессом-субрепером" с PID,
                отличным от 1.
*/
#include "tlpi_hdr.h"

int
main(int argc, char *argv[])
{
    pid_t ppid, ppidOrig;

    setbuf(stdout, NULL);       /* Отключаем буферизацию вывода stdout */

    ppidOrig = getpid();        /* Запоминаем начальный PID родительского процесса */

    switch (fork()) {
    case -1:
        errExit("fork");        /* В случае ошибки fork() */

    case 0:                     /* Код для дочернего процесса */
        /* Цикл продолжается до тех пор, пока дочерний процесс не осиротеет */
        while ((ppid = getppid()) == ppidOrig) {   
            printf("Child running (parent PID=%ld)\n", (long) ppid);
            sleep(1);           /* Пауза на 1 секунду */
        }
        /* После того как родительский процесс завершается, PID родителя меняется */
        printf("Child is orphaned (parent PID=%ld)\n", (long) ppid);
        exit(EXIT_SUCCESS);

    default:                    /* Код для родительского процесса */
        printf("Parent (PID=%ld) sleeping\n", (long) getpid());
        sleep(3);               /* Даем дочернему процессу время для запуска */
        printf("Parent exiting\n");
        exit(EXIT_SUCCESS);      /* Родитель завершает выполнение */
    }
}

/*
### Резюме кода:

Эта программа демонстрирует механизм, при котором дочерний процесс становится "сиротой", если его родительский процесс завершается. 

1. Программа создает дочерний процесс с помощью `fork()`.
2. Дочерний процесс зацикливается, периодически проверяя PID своего родителя.
3. Родительский процесс "засыпает" на 3 секунды, после чего завершает выполнение.
4. Когда родительский процесс завершается, дочерний процесс обнаруживает, что его родитель изменился (обычно на init или другой субрепер-процесс), и завершает выполнение, выводя сообщение о своем "осиротении".

Таким образом, программа наглядно показывает, что, если родительский процесс завершается раньше дочернего, последний становится сиротой и получает нового родителя — обычно это процесс с PID 1, но на современных системах это может быть и другой субрепер.
*/