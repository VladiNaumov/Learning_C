/* exit_handlers.c

   Демонстрирует использование функций atexit(3) и on_exit(3), которые позволяют
   регистрировать функции (так называемые "обработчики выхода"), которые будут 
   вызваны при нормальном завершении процесса. (Эти функции не вызываются, если процесс 
   завершает работу через _exit(2) или если процесс завершён сигналом.)
*/
#define _BSD_SOURCE     /* Определение on_exit() из <stdlib.h> */
#include <stdlib.h>
#include "tlpi_hdr.h"

#ifdef __linux__        /* Некоторые реализации UNIX не имеют on_exit() */
#define HAVE_ON_EXIT
#endif

/* Обработчик выхода, который будет вызван через atexit() */
static void
atexitFunc1(void)
{
    printf("Функция atexit 1 вызвана\n");
}

/* Другой обработчик выхода, который будет вызван через atexit() */
static void
atexitFunc2(void)
{
    printf("Функция atexit 2 вызвана\n");
}

#ifdef HAVE_ON_EXIT
/* Обработчик выхода, который будет вызван через on_exit() */
static void
onexitFunc(int exitStatus, void *arg)
{
    printf("Функция on_exit вызвана: статус=%d, arg=%ld\n",
                exitStatus, (long) arg);
}
#endif

int
main(int argc, char *argv[])
{
#ifdef HAVE_ON_EXIT
    /* Регистрация обработчика через on_exit() с аргументом 10 */
    if (on_exit(onexitFunc, (void *) 10) != 0)
        fatal("on_exit 1");
#endif
    /* Регистрация обработчиков через atexit() */
    if (atexit(atexitFunc1) != 0)
        fatal("atexit 1");
    if (atexit(atexitFunc2) != 0)
        fatal("atexit 2");
#ifdef HAVE_ON_EXIT
    /* Регистрация другого обработчика через on_exit() с аргументом 20 */
    if (on_exit(onexitFunc, (void *) 20) != 0)
        fatal("on_exit 2");
#endif

    /* Завершаем процесс с кодом выхода 2 */
    exit(2);
}

/*

### Резюме кода:

Этот пример демонстрирует использование двух функций для регистрации обработчиков выхода:

1. **`atexit()`**: Функция для регистрации обработчиков, которые будут вызваны при нормальном завершении программы. В примере зарегистрированы два обработчика:
   - `atexitFunc1()`
   - `atexitFunc2()`

2. **`on_exit()`**: Это более специфичная функция для Linux, которая также позволяет зарегистрировать обработчики. Каждый обработчик может получить дополнительный аргумент. В примере зарегистрированы два обработчика с аргументами `10` и `20`.

Процесс завершится с кодом `exit(2)`. При завершении программы обработчики будут вызваны в том порядке, в котором они были зарегистрированы.

- Обработчики, зарегистрированные с помощью **`atexit()`**, будут вызываться по очереди, в порядке регистрации, в момент завершения программы.
- Обработчики, зарегистрированные с помощью **`on_exit()`**, будут вызываться в порядке регистрации, но с передачей дополнительных аргументов.

Функции, зарегистрированные через `atexit()` и `on_exit()`, не вызываются, если процесс завершается с помощью **`_exit()`** или из-за сигнала.

*/