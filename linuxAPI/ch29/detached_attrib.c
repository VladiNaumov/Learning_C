/* detached_attrib.c

   Пример использования атрибутов POSIX-потоков (pthread_attr_t):
   создание отделенного потока.
*/

#include <pthread.h>  // Для работы с потоками
#include "tlpi_hdr.h" // Библиотека вспомогательных функций для обработки ошибок

/* Функция, выполняемая в потоке */
static void *threadFunc(void *x) {
    return x;  // Поток просто возвращает переданный ему аргумент
}

int main(int argc, char *argv[]) {
    pthread_t thr;               // Идентификатор потока
    pthread_attr_t attr;         // Атрибуты потока
    int s;                       // Для хранения кодов возврата функций pthread

    /* Инициализация атрибутов потока с настройками по умолчанию */
    s = pthread_attr_init(&attr);
    if (s != 0)
        errExitEN(s, "pthread_attr_init");

    /* Устанавливаем атрибут потока в состояние "отделенного" */
    s = pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
    if (s != 0)
        errExitEN(s, "pthread_attr_setdetachstate");

    /* Создаем поток с заданными атрибутами */
    s = pthread_create(&thr, &attr, threadFunc, (void *) 1);  // Аргумент передается как указатель
    if (s != 0)
        errExitEN(s, "pthread_create");

    /* Уничтожаем объект атрибутов, так как он больше не нужен */
    s = pthread_attr_destroy(&attr);
    if (s != 0)
        errExitEN(s, "pthread_attr_destroy");

    /* Попытка выполнить pthread_join с отделенным потоком должна завершиться ошибкой */
    s = pthread_join(thr, NULL);
    if (s != 0)
        printf("pthread_join failed as expected: %s\n", strerror(s));

    exit(EXIT_SUCCESS);  // Успешное завершение программы
}

/*
Краткое объяснение:
1. Инициализация атрибутов потока через `pthread_attr_init()`.
2. Установка атрибута `PTHREAD_CREATE_DETACHED`, чтобы поток стал "отделенным".
   - Отделенный поток не может быть ожидать с помощью `pthread_join()`.
   - Ресурсы такого потока автоматически освобождаются после завершения.
3. Создание потока с заданным атрибутом.
4. Уничтожение объекта атрибутов с помощью `pthread_attr_destroy()` для экономии памяти.
5. Попытка вызвать `pthread_join()` для отделенного потока завершается ошибкой, что ожидаемо.


### Основные моменты:
- **Отделенные потоки** полезны, когда не требуется ожидать их завершения. Например, для обработки задач в фоне.
- Вызов `pthread_join()` для отделенного потока вызывает ошибку, так как его ресурсы освобождаются автоматически.
- Всегда уничтожайте атрибуты с `pthread_attr_destroy()` после их использования.

*/