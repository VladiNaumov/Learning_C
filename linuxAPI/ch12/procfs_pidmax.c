
/* procfs_pidmax.c

   Программа показывает, как обращаться к файлу в файловой системе /proc.
   Она позволяет читать и изменять файл /proc/sys/kernel/pid_max (доступен только в Linux 2.6 и более поздних версиях).

   Использование: procfs_pidmax [new-pidmax]

       Программа отображает текущее максимальное значение PID.
       Если передан аргумент командной строки, устанавливает это значение PID.
       
       Примечание: для изменения максимального значения PID требуются привилегии.

   Программа специфична для Linux.
*/

#include <fcntl.h>
#include "tlpi_hdr.h"

#define MAX_LINE 100

int main(int argc, char *argv[]) {
    int fd;
    char line[MAX_LINE];
    ssize_t n;

    // Открытие файла в режиме чтения или чтения-записи в зависимости от аргументов
    fd = open("/proc/sys/kernel/pid_max", (argc > 1) ? O_RDWR : O_RDONLY);
    if (fd == -1)
        errExit("open");

    // Чтение текущего значения из файла
    n = read(fd, line, MAX_LINE);
    if (n == -1)
        errExit("read");

    if (argc > 1)
        printf("Old value: ");
    printf("%.*s", (int) n, line);

    // Если указан аргумент, записываем новое значение PID
    if (argc > 1) {
        if (lseek(fd, 0, SEEK_SET) == -1)  // Перемещаем указатель в начало файла
            errExit("lseek");

        if (write(fd, argv[1], strlen(argv[1])) != strlen(argv[1]))  // Записываем новое значение
            fatal("write() failed");

        // Проверяем новое значение, вызвав системную команду echo
        system("echo /proc/sys/kernel/pid_max now contains "
               "`cat /proc/sys/kernel/pid_max`");
    }

    exit(EXIT_SUCCESS);
}
/*

### Пояснение работы программы

1. **Открытие файла**:
   - Файл `/proc/sys/kernel/pid_max` открывается в режиме чтения (`O_RDONLY`) или чтения-записи (`O_RDWR`), если был передан аргумент командной строки (новое значение для `pid_max`).
   - Если открытие не удалось, программа завершится с ошибкой.

2. **Чтение текущего значения `pid_max`**:
   - Значение читается из файла с помощью `read` и сохраняется в строку `line`.
   - После чтения выводится текущее значение максимального PID. Если указано новое значение, перед выводом текущего значения добавляется `Old value: `.

3. **Изменение `pid_max` (при наличии аргумента)**:
   - Если программа была запущена с аргументом, с помощью `lseek` указатель файла перемещается в начало, чтобы новое значение перезаписало старое.
   - Затем `write` записывает новое значение из `argv[1]`.
   - После успешной записи программа выполняет системную команду `echo`, которая проверяет, что значение `pid_max` изменилось. Она выводит новое значение с помощью `cat`.

4. **Завершение программы**:
   - Если программа выполнилась успешно, она завершится с кодом `EXIT_SUCCESS`.

### Использование

- Запустите программу без аргументов, чтобы вывести текущее значение `pid_max`:
  ```bash
  ./procfs_pidmax
  ```

- Укажите новое значение `pid_max` (например, 50000), чтобы изменить его:
  ```bash
  sudo ./procfs_pidmax 50000
  ```
  **Примечание**: Для изменения `pid_max` требуются привилегии администратора, поэтому необходимо использовать `sudo`.
  
  */
