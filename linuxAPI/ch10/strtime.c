/* Этот код демонстрирует использование функций `strptime()` и `strftime()`,
 которые предназначены для работы с датой и временем. Он принимает на вход строку с датой и временем, формат для её разбора и, 
 при желании, формат для её обратного преобразования в строку.*/

/* strtime.c

   Демонстрация использования strptime() и strftime().

   Функция strptime() обрабатывает "input-date+time" с использованием указанного "format".
   Преобразование затем возвращается обратно с помощью вызова strftime() с указанным
   "out-format" (или, если аргумент отсутствует, используется формат по умолчанию).
*/

#if ! defined(__sun)
#ifndef _XOPEN_SOURCE
#define _XOPEN_SOURCE
#endif
#endif

#include <time.h>
#include <locale.h>
#include "tlpi_hdr.h"  // Вспомогательный заголовочный файл с функциями обработки ошибок

#define SBUF_SIZE 1000  // Размер буфера для строки

int main(int argc, char *argv[])
{
    struct tm tm;         // Структура для хранения разбора даты и времени
    char sbuf[SBUF_SIZE]; // Буфер для строки результата strftime
    char *ofmt;           // Указатель на строку формата для вывода

    // Проверка на корректное количество аргументов
    if (argc < 3 || strcmp(argv[1], "--help") == 0)
        usageErr("%s input-date-time in-format [out-format]\n", argv[0]);

    // Устанавливаем локальные настройки для корректной работы с датой и временем
    if (setlocale(LC_ALL, "") == NULL)
        errExit("setlocale");

    // Инициализируем структуру tm
    memset(&tm, 0, sizeof(struct tm));

    // Разбираем дату и время из строки argv[1] согласно формату argv[2]
    if (strptime(argv[1], argv[2], &tm) == NULL)
        fatal("strptime");

    // Устанавливаем tm_isdst в -1, чтобы mktime() сам определил наличие летнего времени
    tm.tm_isdst = -1;
    printf("Время в секундах с начала эпохи: %ld\n", (long) mktime(&tm));

    // Если задан формат вывода, используем его, иначе - формат по умолчанию
    ofmt = (argc > 3) ? argv[3] : "%H:%M:%S %A, %d %B %Y %Z";
    
    // Преобразуем tm в строку согласно указанному формату
    if (strftime(sbuf, SBUF_SIZE, ofmt, &tm) == 0)
        fatal("strftime вернул 0");

    printf("Результат strftime(): %s\n", sbuf);

    exit(EXIT_SUCCESS);
}

/*

### Пояснение
1. **Аргументы**:
   - `input-date-time` — строка с датой и временем для разбора.
   - `in-format` — формат, описывающий `input-date-time` (для `strptime()`).
   - `out-format` (опционально) — формат для преобразования даты обратно в строку (для `strftime()`).

2. **setlocale()**:
   - Устанавливает локальные настройки для корректного отображения дат и времени.

3. **strptime()**:
   - Парсит строку `input-date-time` согласно формату `in-format` и заполняет структуру `tm`.

4. **mktime()**:
   - Преобразует `tm` в `time_t` (секунды с начала эпохи) и определяет наличие летнего времени (`tm_isdst = -1`).

5. **strftime()**:
   - Преобразует структуру `tm` обратно в строку по формату `out-format`. Если формат не задан, используется формат по умолчанию.

Этот код удобен для преобразования дат и времени между различными форматами.
*/