/* thread_cancel.c

   Пример использования pthread_cancel() для отмены POSIX-потока.
*/

#include <pthread.h>
#include "tlpi_hdr.h"

/*
 * threadFunc: Функция потока.
 * 
 * В бесконечном цикле выводит сообщения с паузами в 1 секунду. 
 * Все используемые функции могут быть точками отмены.
 */
static void *threadFunc(void *arg) {
    int j;

    printf("Поток запущен\n");     /* Может быть точкой отмены */
    for (j = 1; ; j++) {
        printf("Итерация %d\n", j); /* Может быть точкой отмены */
        sleep(1);                   /* Точка отмены */
    }

    /* НЕ ДОСТИЖИМО */
    return NULL;
}

int main(int argc, char *argv[]) {
    pthread_t thr;
    int s;
    void *res;

    // Создаем поток
    s = pthread_create(&thr, NULL, threadFunc, NULL);
    if (s != 0)
        errExitEN(s, "pthread_create");

    sleep(3); // Даём потоку проработать некоторое время

    // Отмена потока
    s = pthread_cancel(thr);
    if (s != 0)
        errExitEN(s, "pthread_cancel");

    // Ожидание завершения потока
    s = pthread_join(thr, &res);
    if (s != 0)
        errExitEN(s, "pthread_join");

    if (res == PTHREAD_CANCELED) // Проверка статуса завершения
        printf("Поток был отменён\n");
    else
        printf("Поток не был отменён (это не должно происходить!)\n");

    exit(EXIT_SUCCESS);
}

/*
 * Описание:
 * 
 * - Поток запускается и выполняет бесконечный цикл с задержкой.
 * - Основной поток ожидает 3 секунды, после чего отменяет поток с помощью pthread_cancel().
 * - Поток завершается в одной из точек отмены (например, sleep()).
 * - pthread_join() используется для ожидания завершения потока и проверки его результата.
 * 
 * Особенности:
 * - `pthread_cancel()` отправляет запрос на завершение потока.
 * - Поток завершится только в определённых точках отмены (например, sleep(), printf()).
 * - Результат `PTHREAD_CANCELED` проверяется для подтверждения, что поток был успешно отменён.
 * 
 * Практическое применение:
 * - Используется для безопасного завершения потоков, когда необходимо принудительно остановить выполняемую задачу.
 */
