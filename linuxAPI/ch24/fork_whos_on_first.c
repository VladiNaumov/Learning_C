/* fork_whos_on_first.c

   Родительский процесс многократно создает дочерний процесс, и затем оба процесса
   соревнуются, чтобы первыми вывести сообщение. (Каждый дочерний процесс завершается после
   вывода своего сообщения.) Результаты выполнения этой программы дают представление о том,
   какой из двух процессов — родитель или ребенок — обычно выполняется первым после fork().

   Какой из процессов будет выполнен первым после fork(), менялось в зависимости
   от версии ядра.
*/

#include <sys/wait.h>
#include "tlpi_hdr.h"

int
main(int argc, char *argv[])
{
    int numChildren, j;
    pid_t childPid;

    if (argc > 1 && strcmp(argv[1], "--help") == 0)
        usageErr("%s [num-children]\n", argv[0]);

    // Устанавливаем количество дочерних процессов на основе аргумента или по умолчанию на 1
    numChildren = (argc > 1) ? getInt(argv[1], GN_GT_0, "num-children") : 1;

    setbuf(stdout, NULL);               // Устанавливаем стандартный вывод без буферизации

    for (j = 0; j < numChildren; j++) {
        switch (childPid = fork()) {
        case -1:
            errExit("fork"); // Сообщение об ошибке, если вызов fork завершился неудачей

        case 0:
            // Дочерний процесс: выводит сообщение и завершается
            printf("%d child\n", j);
            _exit(EXIT_SUCCESS);

        default:
            // Родительский процесс: выводит сообщение и ждет завершения дочернего процесса
            printf("%d parent\n", j);
            wait(NULL);                 // Ожидание завершения дочернего процесса
            break;
        }
    }

    exit(EXIT_SUCCESS);
}
/*
### Резюме кода
Эта программа демонстрирует конкуренцию между родительским и дочерним процессами после вызова `fork()`. 
Родитель многократно создает дочерний процесс, и оба процесса сразу выводят сообщение, указывая на очередность выполнения. 
Каждый дочерний процесс завершается после вывода сообщения, а родитель ожидает его завершения перед созданием следующего ребенка. 
Программа позволяет исследовать, какой из процессов обычно получает доступ к процессору первым после `fork()` — родитель или ребенок.
*/